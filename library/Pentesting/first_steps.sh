#!/bin/bash

# Thanks to s4vitar docu for OSCP:            https://gist.github.com/s4vitar/b88fefd5d9fbbdcc5f30729f7e06826e
# Thanks to ralish for his script template:   https://github.com/ralish/bash-script-template/blob/stable/template.sh

TARGET_IP=""
ALL_PORTS=""

function get_nmap_report(){
    # nmap attack (unset -Pn for net scan)
    nmap -p- --open -T5 -v -oG allPorts $TARGET_IP -n -Pn
    ALL_PORTS=$(cat allPorts | grep -oP '\d{2,5}/open' | awk '{print $1}' FS="/" | xargs | tr ' ' ',')

    nmap -p$ALL_PORTS -sC -sV $TARGET_IP -oN targeted -Pn
}

function get_webservice_report(){
    ALL_PORTS="$(cat allPorts | grep -oP '\d{2,5}/open' | awk '{print $1}' FS="/" | xargs | tr ' ' ',')"
    
    if [[ $ALL_PORTS == *"80"* ]];
    then
        dirb http://$TARGET_IP/ -r -o dirb80.log
        nikto -h $TARGET_IP -o nikto80.log -Format txt
    fi

    if [[ $ALL_PORTS == *"8080"* ]];
    then
        dirb http://$TARGET_IP:8080/ -r -o dirb443.log
        nikto -h $TARGET_IP:8080 -o nikto443.log -Format txt
    fi

    if [[ $ALL_PORTS == *"443"* ]];
    then
        dirb https://$TARGET_IP/ -r -o dirb8080.log
        nikto -h $TARGET_IP -o nikto8080.log -Format txt
    fi

    if [[ $ALL_PORTS == *"8443"* ]];
    then
        dirb https://$TARGET_IP:8443/ -r -o dirb8443.log
        nikto -h $TARGET_IP:8443 -o nikto8443.log -Format txt
    fi
}

function script_usage() {
	cat << EOF
USAGE:    ${0##*/} [-h] | TARGET_IP
EXAMPLE:  ${0##*/} 10.10.10.130

PARAMS:    
  -h       Displays this help
EOF
}

function script_init() {

    readonly orig_cwd="$PWD"
    readonly script_path="${BASH_SOURCE[0]}"
    readonly script_dir="$(dirname "$script_path")"
    readonly script_name="$(basename "$script_path")"
    readonly script_params="$*"

    # Important to always set as we use it in the exit handler
    readonly ta_none="$(tput sgr0 2> /dev/null || true)"
}
function parse_params() {
    local param
    while [[ $# -gt 0 ]]; do
        param="$1"
        shift
        case $param in
            -h | --help)
                script_usage
                exit 0
                ;;
#            -v | --verbose)
#                verbose=true
#                ;;
#            -nc | --no-colour)
#                no_colour=true
#                ;;
#            -cr | --cron)
#                cron=true
#                ;;
            *)
                echo "IP got: $param" 
                ;;
        esac
    done
}

function main() {
	script_init "$0"
	parse_params "$1"
	TARGET_IP=$1
	
	#get_nmap_report "$TARGET_IP"
    get_webservice_report "$TARGET_IP"
	
}

main "$@"
